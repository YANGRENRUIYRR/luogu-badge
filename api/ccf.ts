import fetch from 'node-fetch';
import type { VercelRequest, VercelResponse } from '@vercel/node';
import parse from 'node-html-parser';

const logo =
    'data:image/x-icon;base64,AAABAAEAICAAAAEAIACoEAAAFgAAACgAAAAgAAAAQAAAAAEAIAAAAAAAABAAABEXAAARFwAAAAAAAAAAAAD///8A////BP///0r///+z////7P/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////u////tf///0v///8E////AP///wP///9k////6///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////6////2X///8D////Sv///+n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////6v///0v///+y////////////////////////////////+vPr/+/Zwf/u1rv/79i///rz7P////////////////////////////////////////////z49P/x3cf/7tW7/+7Wu//37N//////////////////////////////////////tP///+r////////////////////////////////py6n/1JpZ/9WaWv/Vmln/5L6V//37+P/////////////////////////////////9+/j/5sOd/9WcXP/Vmlr/1JlX/+jIpf/////////////////////////////////////s/////v////////////////////////////////Tk0//Yomf/1Zpa/9WbW//WnV//7ta8/////v////////////////////////////DbxP/Wnl//1Zta/9WaWf/bqXP/9urd//////////////////////////////////////////////////////////////////////////////7+/+vPsf/VnFz/1Ztb/9WaWv/Yo2j/8d7I///////////////////////47eL/3Kx2/9WaWf/Vmlr/2KNo//Phzv///////////////////////////////////////////////////////////////////////////////////////Pn1/+XAmP/Vmlr/1Ztb/9WaWf/apm3/9OTT////////////+vLq/9+zgv/Vmln/1Ztb/9WcXP/r0bP////+////////////////////////////////////////////////////////////////////////////////////////////+vTt/+C2h//Vmln/1Ztb/9WaWf/bqnP/9unb//z48//iu4//1ZpZ/9WbW//Umln/37SE//z38v//////////////////////////////////////////////////////////////////////////////////////////////////////+fHo/+C1hv/Vmlr/1Ztb/9SaWf/dr3z/5sSe/9WbXP/Vmlr/1JlY/9mkav/05dT/////////////////////////////////////////////////////////////////////////////////////////////////////////////////+vPs/+O8kf/Vm1r/1Ztb/9WbWv/Vm1z/1p1e/9iiZv/esH3/8uDM///+/v//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+/bw/+S/lv/Vm1v/1Ztb/9WaWv/ZpWz/8NzF//z59f///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Pjz/+TAl//Vm1v/1Ztb/9WbW//gtof/+fHp/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Pj0//Tk0v/v2cH/8NzG/+K5jP/Vm1v/1Ztb/9WaWf/ht4n/+vPs//////////////////////////////////////////////////////////////////////////////////////////////////////////////////r07f/jvJH/1p5f/9WbW//XoGT/7dS5/+O8kf/Vmlr/1Ztb/9WaWv/huIv/+vPr///////////////////////////////////////////////////////////////////////////////////////////////////////68+z/4biK/9WaWv/Vm1v/1Ztb/9WbW//w28P/+/Xv/+G3if/Vmlr/1Ztb/9WaWv/gtoj/+vLq////////////////////////////////////////////////////////////////////////////////////////////+/bw/+K5jP/Vmln/1Ztb/9WbWv/UmVj/4LSE//v17///////+fHo/96wff/Vmlr/1Ztb/9WaWf/iuo3//Pfy///////////////////////////////////////////////////////////////////////////////////+/v/pyqn/1Zpa/9WbW//Vm1v/16Bk/+TAl//58Of////////////8+fX/5cGa/9WaWf/Vm1v/1Ztb/9WcXP/x3sn/////////////////////////////////////////////////////////////////////////////////+/bx/9ysdv/Vmln/1Ztb/9WaWv/qzq///v38/////////v7/9OTT/9+zg//WnV7/1Ztb/9WbW//Vmlr/2KNo//bp2//////////////////////////////////////////////////////////////////////////////////9+fX/3rF//9SaWf/Vm1v/1Zpa/+fGof/9+/n//////+7Xvf/Yo2j/1JpZ/9WbW//Vm1v/1Zpa/9WcXP/rz7D///79///////////////////////////////////////////////////////////////////////////////////////t1br/1Zxc/9WbWv/Vm1v/1p1e/+TAl//58en/4LWG/9SYVv/Vmlr/1Zxc/9WcXP/YoWX/6Mmm//369/////////////////////////////////////////////////////////////////////////////////////////////369v/nxqH/1p1e/9WbWv/Vm1v/1ZpZ/+G4i//v2cD/7ta8/+7WvP/w28X/8d3H//Xo2f/+/fv///////////////////////////////////////////////////////////////////////////////////////////////////////37+P/pyqj/1p1e/9WbW//Vm1v/1Zpa/+S+lP/8+PT///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////37+P/mw53/1Zpa/9WbW//Vm1v/1Ztb/+nKqP///v7///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////rz7P/fsoD/1JpZ/9WbW//Vmlr/2aRp//bq3P////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Tl1P/Yo2n/1Zpa/9WbW//Umln/58ai/////////////////////////////////////////////////////////////////////////////////v/////////////////////////////////////////////////////////////+/+3Uuf/WnV7/1Zta/9WaWf/crXj/+/fx///////////////////////////////////////////////////////////////////////////q/////////////////////////////////////////////////////////////////fv4/+jIpv/Wnl//1JhW/96xf//8+PT/////////////////////////////////////////////////////////////////////6////7H//////////////////////////////////////////////////////////////////////fv5//Dcxf/pyqj/9efY//////////////////////////////////////////////////////////////////////////+y////Sf///+n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////6f///0r///8D////Yf///+n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+v///9j////A////wD///8D////R////7H////r/////v///////////////////////////////////////////////////////////////////////////////////////////////////////////////v///+v///+y////Sf///wT///8AgAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAE=';
interface UserRatingInfo {
    rating: number;
    text: string;
    uid: number;
}

function escape(username: string) {
    return encodeURIComponent(username.replace(/-/g, '--').replace(/_/g, '__'));
}

function getRatingColor(rating: number) {
    if (rating >= 8) return '808080';//FFC116
    if (rating >= 6) return '808080';//3498DB
    if (rating >= 3) return '808080';//5EB95E
    return '808080';
}

async function fetchData(username: string): Promise<UserRatingInfo> {
    const res = await fetch("https://www.luogu.com.cn/api/user/search?keyword="+username);
    if (!res.ok) return { rating: 0, text: 'N/A' };
    const data = await res.json();
    const user = data.users;
    if (user.length==0) return { rating: 0, text: 'N/A' };
    let user0=user[0];
    return {rating: user0.ccfLevel,text: "CCF"+user0.ccfLevel+"级", uid: user0.uid }
}

async function getBadgeImage(username: string, data: UserRatingInfo, style: string) {
    const color = getRatingColor(data.rating);
    const escapedUsername = escape(username);
    const escapedRatingText = escape(data.text);

    const params = new URLSearchParams({
        longCache: 'true',
        style,
        logo,
        link: `https://www.luogu.com.cn/user/`+data.uid,
    }).toString();

    console.log(params);

    const res = await fetch(
        `https://img.shields.io/badge/${escapedUsername}-${escapedRatingText}-${color}.svg?${params}`
    );

    if (!res.ok) throw 'error';
    return await res.text();
}

export default async (request: VercelRequest, response: VercelResponse) => {
    let { username = 'yangrenruiYRR', style = 'for-the-badge' } = request.query;

    if (Array.isArray(username)) username = username[0];
    if (Array.isArray(style)) style = style[0];

    const data = await fetchData(username as string).catch(() => ({ rating: 0, text: 'N/A', uid: 0}));
    getBadgeImage(username as string, data, style as string)
        .then((data) => {
            response
                .status(200)
                .setHeader('Content-Type', 'image/svg+xml;charset=utf-8')
                .setHeader('Cache-Control', 'public, max-age=43200') // 43200s（12h） cache
                .send(data);
        })
        .catch(() => {
            response.status(500).send('error');
        });
};
